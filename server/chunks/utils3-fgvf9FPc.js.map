{"version":3,"file":"utils3-fgvf9FPc.js","sources":["../../../.svelte-kit/adapter-node/chunks/utils3.js"],"sourcesContent":["import { s as sendNotification } from \"./index3.js\";\nimport { N as NotificationType } from \"./types3.js\";\nimport { e as error } from \"./index.js\";\nimport dayjs from \"dayjs\";\nimport \"devalue\";\nimport { s as superValidate } from \"./superValidate.js\";\nimport \"just-clone\";\nimport \"ts-deepmerge\";\nimport \"memoize-weak\";\nimport { z as zod } from \"./zod.js\";\nimport { b as bookingSchema } from \"./schema2.js\";\nimport { cF as booking_errors_notFound } from \"./messages.js\";\nconst actions = {\n  accept: async (event) => {\n    await performAction(event, true);\n  },\n  reject: async (event) => {\n    await performAction(event, false);\n  }\n};\nasync function getUpcomingBookingRequests(prisma) {\n  return prisma.bookingRequest.findMany({\n    where: {\n      start: {\n        gte: dayjs().subtract(1, \"week\").toDate()\n      }\n    },\n    orderBy: [{ start: \"asc\" }, { end: \"asc\" }, { status: \"asc\" }],\n    include: {\n      bookables: true,\n      booker: true\n    }\n  });\n}\nasync function getBookingRequestOrThrow(prisma, id) {\n  return prisma.bookingRequest.findUniqueOrThrow({\n    where: { id },\n    include: { bookables: true }\n  }).catch(() => {\n    throw error(404, booking_errors_notFound());\n  });\n}\nasync function getSuperValidatedForm(bookingRequest) {\n  const initialData = {\n    name: bookingRequest.event ?? void 0,\n    start: bookingRequest.start ? dayjs(bookingRequest.start).format(\"YYYY-MM-DDTHH:mm\") : void 0,\n    end: bookingRequest.end ? dayjs(bookingRequest.end).format(\"YYYY-MM-DDTHH:mm\") : void 0,\n    bookables: bookingRequest.bookables?.map((bookable) => bookable.id)\n  };\n  return await superValidate(initialData, zod(bookingSchema));\n}\nasync function performAction(event, accepted) {\n  const { request, locals } = event;\n  const { prisma, user } = locals;\n  const formData = await request.formData();\n  const id = formData.get(\"id\");\n  const status = accepted ? \"ACCEPTED\" : \"DENIED\";\n  if (id && typeof id === \"string\") {\n    await prisma.bookingRequest.update({\n      where: {\n        id\n      },\n      data: {\n        status\n      }\n    });\n    const request2 = await prisma.bookingRequest.findFirst({\n      where: {\n        id\n      },\n      select: {\n        bookerId: true,\n        event: true\n      }\n    });\n    if (request2 && request2.bookerId != null && user && user.memberId) {\n      sendNotification({\n        title: `Booking request ${status.toLowerCase()}`,\n        message: `Your booking request for ${request2.event} has been ${status.toLowerCase()}`,\n        type: NotificationType.BOOKING_REQUEST,\n        link: `/booking`,\n        memberIds: [request2.bookerId],\n        fromMemberId: user.memberId\n      });\n    }\n  }\n}\nexport {\n  getSuperValidatedForm as a,\n  getUpcomingBookingRequests as b,\n  actions as c,\n  getBookingRequestOrThrow as g\n};\n"],"names":[],"mappings":";;;;;;;;AAYK,MAAC,OAAO,GAAG;AAChB,EAAE,MAAM,EAAE,OAAO,KAAK,KAAK;AAC3B,IAAI,MAAM,aAAa,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;AACrC,GAAG;AACH,EAAE,MAAM,EAAE,OAAO,KAAK,KAAK;AAC3B,IAAI,MAAM,aAAa,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;AACtC,GAAG;AACH,EAAE;AACF,eAAe,0BAA0B,CAAC,MAAM,EAAE;AAClD,EAAE,OAAO,MAAM,CAAC,cAAc,CAAC,QAAQ,CAAC;AACxC,IAAI,KAAK,EAAE;AACX,MAAM,KAAK,EAAE;AACb,QAAQ,GAAG,EAAE,KAAK,EAAE,CAAC,QAAQ,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC,MAAM,EAAE;AACjD,OAAO;AACP,KAAK;AACL,IAAI,OAAO,EAAE,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,EAAE,EAAE,GAAG,EAAE,KAAK,EAAE,EAAE,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC;AAClE,IAAI,OAAO,EAAE;AACb,MAAM,SAAS,EAAE,IAAI;AACrB,MAAM,MAAM,EAAE,IAAI;AAClB,KAAK;AACL,GAAG,CAAC,CAAC;AACL,CAAC;AACD,eAAe,wBAAwB,CAAC,MAAM,EAAE,EAAE,EAAE;AACpD,EAAE,OAAO,MAAM,CAAC,cAAc,CAAC,iBAAiB,CAAC;AACjD,IAAI,KAAK,EAAE,EAAE,EAAE,EAAE;AACjB,IAAI,OAAO,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE;AAChC,GAAG,CAAC,CAAC,KAAK,CAAC,MAAM;AACjB,IAAI,MAAM,KAAK,CAAC,GAAG,EAAE,uBAAuB,EAAE,CAAC,CAAC;AAChD,GAAG,CAAC,CAAC;AACL,CAAC;AACD,eAAe,qBAAqB,CAAC,cAAc,EAAE;AACrD,EAAE,MAAM,WAAW,GAAG;AACtB,IAAI,IAAI,EAAE,cAAc,CAAC,KAAK,IAAI,KAAK,CAAC;AACxC,IAAI,KAAK,EAAE,cAAc,CAAC,KAAK,GAAG,KAAK,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,kBAAkB,CAAC,GAAG,KAAK,CAAC;AACjG,IAAI,GAAG,EAAE,cAAc,CAAC,GAAG,GAAG,KAAK,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC,kBAAkB,CAAC,GAAG,KAAK,CAAC;AAC3F,IAAI,SAAS,EAAE,cAAc,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC,QAAQ,KAAK,QAAQ,CAAC,EAAE,CAAC;AACvE,GAAG,CAAC;AACJ,EAAE,OAAO,MAAM,aAAa,CAAC,WAAW,EAAE,GAAG,CAAC,aAAa,CAAC,CAAC,CAAC;AAC9D,CAAC;AACD,eAAe,aAAa,CAAC,KAAK,EAAE,QAAQ,EAAE;AAC9C,EAAE,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG,KAAK,CAAC;AACpC,EAAE,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,CAAC;AAClC,EAAE,MAAM,QAAQ,GAAG,MAAM,OAAO,CAAC,QAAQ,EAAE,CAAC;AAC5C,EAAE,MAAM,EAAE,GAAG,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AAChC,EAAE,MAAM,MAAM,GAAG,QAAQ,GAAG,UAAU,GAAG,QAAQ,CAAC;AAClD,EAAE,IAAI,EAAE,IAAI,OAAO,EAAE,KAAK,QAAQ,EAAE;AACpC,IAAI,MAAM,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC;AACvC,MAAM,KAAK,EAAE;AACb,QAAQ,EAAE;AACV,OAAO;AACP,MAAM,IAAI,EAAE;AACZ,QAAQ,MAAM;AACd,OAAO;AACP,KAAK,CAAC,CAAC;AACP,IAAI,MAAM,QAAQ,GAAG,MAAM,MAAM,CAAC,cAAc,CAAC,SAAS,CAAC;AAC3D,MAAM,KAAK,EAAE;AACb,QAAQ,EAAE;AACV,OAAO;AACP,MAAM,MAAM,EAAE;AACd,QAAQ,QAAQ,EAAE,IAAI;AACtB,QAAQ,KAAK,EAAE,IAAI;AACnB,OAAO;AACP,KAAK,CAAC,CAAC;AACP,IAAI,IAAI,QAAQ,IAAI,QAAQ,CAAC,QAAQ,IAAI,IAAI,IAAI,IAAI,IAAI,IAAI,CAAC,QAAQ,EAAE;AACxE,MAAM,gBAAgB,CAAC;AACvB,QAAQ,KAAK,EAAE,CAAC,gBAAgB,EAAE,MAAM,CAAC,WAAW,EAAE,CAAC,CAAC;AACxD,QAAQ,OAAO,EAAE,CAAC,yBAAyB,EAAE,QAAQ,CAAC,KAAK,CAAC,UAAU,EAAE,MAAM,CAAC,WAAW,EAAE,CAAC,CAAC;AAC9F,QAAQ,IAAI,EAAE,gBAAgB,CAAC,eAAe;AAC9C,QAAQ,IAAI,EAAE,CAAC,QAAQ,CAAC;AACxB,QAAQ,SAAS,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC;AACtC,QAAQ,YAAY,EAAE,IAAI,CAAC,QAAQ;AACnC,OAAO,CAAC,CAAC;AACT,KAAK;AACL,GAAG;AACH;;;;"}