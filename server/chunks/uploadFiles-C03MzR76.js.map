{"version":3,"file":"uploadFiles-C03MzR76.js","sources":["../../../.svelte-kit/adapter-node/chunks/uploadFiles.js"],"sourcesContent":["import { f as fileHandler } from \"./fileHandler.js\";\nimport { c2 as members_errors_couldntUploadFile } from \"./messages.js\";\nimport sharp from \"sharp\";\nimport { p as prepareNameForFilesystem, g as getNameOfFile, i as isFileImage } from \"./utils2.js\";\nimport { M as MINIO_BASE_URL } from \"./client3.js\";\nconst compressImage = async (image, options) => await sharp(await image.arrayBuffer()).rotate().resize({\n  fit: \"cover\",\n  withoutEnlargement: true,\n  ...options?.resize\n}).webp(options?.webp).toBuffer();\nconst uploadFile = async (user, file, prefix, bucket, name, compressionOptions) => {\n  let formattedName = prepareNameForFilesystem(\n    name ?? getNameOfFile(file.name),\n    file.name\n  );\n  const filePath = `${prefix}/${formattedName}`;\n  let dataToUpload = file;\n  if (isFileImage(file) && compressionOptions !== false) {\n    try {\n      dataToUpload = await compressImage(file, compressionOptions);\n      formattedName = prepareNameForFilesystem(\n        name ?? getNameOfFile(file.name),\n        file.name,\n        \"webp\"\n      );\n    } catch (e) {\n      const errMsg = e instanceof Error ? e.message : String(e);\n      throw new Error(`Could not compress image: ${errMsg}`);\n    }\n  }\n  try {\n    const putUrl = await fileHandler.getPresignedPutUrl(\n      user,\n      bucket,\n      filePath,\n      true\n    );\n    const res = await fetch(putUrl, {\n      method: \"PUT\",\n      body: dataToUpload\n    });\n    if (!res.ok)\n      throw new Error(\n        `${members_errors_couldntUploadFile()}: ${await res.text()}`\n      );\n    return `${MINIO_BASE_URL}${bucket}/${filePath}`;\n  } catch (e) {\n    console.error(e);\n    const errMsg = e instanceof Error ? e.message : String(e);\n    throw new Error(`${members_errors_couldntUploadFile()}: ${errMsg}`);\n  }\n};\nexport {\n  uploadFile as u\n};\n"],"names":[],"mappings":";;;;;;AAKA,MAAM,aAAa,GAAG,OAAO,KAAK,EAAE,OAAO,KAAK,MAAM,KAAK,CAAC,MAAM,KAAK,CAAC,WAAW,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC,MAAM,CAAC;AACvG,EAAE,GAAG,EAAE,OAAO;AACd,EAAE,kBAAkB,EAAE,IAAI;AAC1B,EAAE,GAAG,OAAO,EAAE,MAAM;AACpB,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC,QAAQ,EAAE,CAAC;AAC7B,MAAC,UAAU,GAAG,OAAO,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,kBAAkB,KAAK;AACnF,EAAE,IAAI,aAAa,GAAG,wBAAwB;AAC9C,IAAI,IAAI,IAAI,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC;AACpC,IAAI,IAAI,CAAC,IAAI;AACb,GAAG,CAAC;AACJ,EAAE,MAAM,QAAQ,GAAG,CAAC,EAAE,MAAM,CAAC,CAAC,EAAE,aAAa,CAAC,CAAC,CAAC;AAChD,EAAE,IAAI,YAAY,GAAG,IAAI,CAAC;AAC1B,EAAE,IAAI,WAAW,CAAC,IAAI,CAAC,IAAI,kBAAkB,KAAK,KAAK,EAAE;AACzD,IAAI,IAAI;AACR,MAAM,YAAY,GAAG,MAAM,aAAa,CAAC,IAAI,EAAE,kBAAkB,CAAC,CAAC;AACnE,MAAM,aAAa,GAAG,wBAAwB;AAC9C,QAAQ,IAAI,IAAI,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC;AACxC,QAAQ,IAAI,CAAC,IAAI;AACjB,QAAQ,MAAM;AACd,OAAO,CAAC;AACR,KAAK,CAAC,OAAO,CAAC,EAAE;AAChB,MAAM,MAAM,MAAM,GAAG,CAAC,YAAY,KAAK,GAAG,CAAC,CAAC,OAAO,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;AAChE,MAAM,MAAM,IAAI,KAAK,CAAC,CAAC,0BAA0B,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC;AAC7D,KAAK;AACL,GAAG;AACH,EAAE,IAAI;AACN,IAAI,MAAM,MAAM,GAAG,MAAM,WAAW,CAAC,kBAAkB;AACvD,MAAM,IAAI;AACV,MAAM,MAAM;AACZ,MAAM,QAAQ;AACd,MAAM,IAAI;AACV,KAAK,CAAC;AACN,IAAI,MAAM,GAAG,GAAG,MAAM,KAAK,CAAC,MAAM,EAAE;AACpC,MAAM,MAAM,EAAE,KAAK;AACnB,MAAM,IAAI,EAAE,YAAY;AACxB,KAAK,CAAC,CAAC;AACP,IAAI,IAAI,CAAC,GAAG,CAAC,EAAE;AACf,MAAM,MAAM,IAAI,KAAK;AACrB,QAAQ,CAAC,EAAE,gCAAgC,EAAE,CAAC,EAAE,EAAE,MAAM,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC;AACpE,OAAO,CAAC;AACR,IAAI,OAAO,CAAC,EAAE,cAAc,CAAC,EAAE,MAAM,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC,CAAC;AACpD,GAAG,CAAC,OAAO,CAAC,EAAE;AACd,IAAI,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;AACrB,IAAI,MAAM,MAAM,GAAG,CAAC,YAAY,KAAK,GAAG,CAAC,CAAC,OAAO,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;AAC9D,IAAI,MAAM,IAAI,KAAK,CAAC,CAAC,EAAE,gCAAgC,EAAE,CAAC,EAAE,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC;AACxE,GAAG;AACH;;;;"}