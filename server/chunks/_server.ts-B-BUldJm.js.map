{"version":3,"file":"_server.ts-B-BUldJm.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/(app)/api/stripe/webhooks/_server.ts.js"],"sourcesContent":["import { d as private_env } from \"../../../../../../chunks/shared-server.js\";\nimport { s as stripe, o as onPaymentCancellation, a as onPaymentFailure, b as onPaymentProcessing, c as onPaymentSuccess } from \"../../../../../../chunks/stripeWebhooks.js\";\nimport { e as error, j as json, i as isHttpError } from \"../../../../../../chunks/index.js\";\nasync function POST({ request }) {\n  const body = await request.text();\n  const signature = request.headers.get(\"stripe-signature\");\n  if (!signature) throw error(400, \"Invalid request\");\n  let event;\n  try {\n    event = stripe.webhooks.constructEvent(\n      body,\n      signature,\n      private_env.SECRET_STRIPE_WEBHOOK_SIGNING\n    );\n  } catch (err) {\n    console.warn(\n      \"⚠️  Webhook signature verification failed.\",\n      err.message\n    );\n    throw error(400, \"Invalid request\");\n  }\n  try {\n    switch (event.type) {\n      case \"payment_intent.succeeded\":\n        await onPaymentSuccess(event.data.object);\n        return json({ message: \"Marked as purchased\" });\n      case \"payment_intent.processing\":\n        await onPaymentProcessing(event.data.object);\n        return json({ message: \"Processing logged\" });\n      case \"payment_intent.payment_failed\":\n        await onPaymentFailure(event.data.object);\n        return json({ message: \"Marked as failed\" });\n      case \"payment_intent.canceled\":\n        await onPaymentCancellation(event.data.object);\n        return json({ message: \"Marked as canceled\" });\n      default:\n        console.log(`Unhandled event type: ${event.type}`);\n        throw error(400, \"Invalid request\");\n    }\n  } catch (e) {\n    if (isHttpError(e)) {\n      throw e;\n    } else if (e instanceof Error) {\n      throw error(500, e.message);\n    } else {\n      throw error(500, \"An unknown error occurred\");\n    }\n  }\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":";;;;;;;;;;;;AAGA,eAAe,IAAI,CAAC,EAAE,OAAO,EAAE,EAAE;AACjC,EAAE,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;AACpC,EAAE,MAAM,SAAS,GAAG,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC;AAC5D,EAAE,IAAI,CAAC,SAAS,EAAE,MAAM,KAAK,CAAC,GAAG,EAAE,iBAAiB,CAAC,CAAC;AACtD,EAAE,IAAI,KAAK,CAAC;AACZ,EAAE,IAAI;AACN,IAAI,KAAK,GAAG,MAAM,CAAC,QAAQ,CAAC,cAAc;AAC1C,MAAM,IAAI;AACV,MAAM,SAAS;AACf,MAAM,WAAW,CAAC,6BAA6B;AAC/C,KAAK,CAAC;AACN,GAAG,CAAC,OAAO,GAAG,EAAE;AAChB,IAAI,OAAO,CAAC,IAAI;AAChB,MAAM,4CAA4C;AAClD,MAAM,GAAG,CAAC,OAAO;AACjB,KAAK,CAAC;AACN,IAAI,MAAM,KAAK,CAAC,GAAG,EAAE,iBAAiB,CAAC,CAAC;AACxC,GAAG;AACH,EAAE,IAAI;AACN,IAAI,QAAQ,KAAK,CAAC,IAAI;AACtB,MAAM,KAAK,0BAA0B;AACrC,QAAQ,MAAM,gBAAgB,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;AAClD,QAAQ,OAAO,IAAI,CAAC,EAAE,OAAO,EAAE,qBAAqB,EAAE,CAAC,CAAC;AACxD,MAAM,KAAK,2BAA2B;AACtC,QAAQ,MAAM,mBAAmB,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;AACrD,QAAQ,OAAO,IAAI,CAAC,EAAE,OAAO,EAAE,mBAAmB,EAAE,CAAC,CAAC;AACtD,MAAM,KAAK,+BAA+B;AAC1C,QAAQ,MAAM,gBAAgB,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;AAClD,QAAQ,OAAO,IAAI,CAAC,EAAE,OAAO,EAAE,kBAAkB,EAAE,CAAC,CAAC;AACrD,MAAM,KAAK,yBAAyB;AACpC,QAAQ,MAAM,qBAAqB,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;AACvD,QAAQ,OAAO,IAAI,CAAC,EAAE,OAAO,EAAE,oBAAoB,EAAE,CAAC,CAAC;AACvD,MAAM;AACN,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,sBAAsB,EAAE,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AAC3D,QAAQ,MAAM,KAAK,CAAC,GAAG,EAAE,iBAAiB,CAAC,CAAC;AAC5C,KAAK;AACL,GAAG,CAAC,OAAO,CAAC,EAAE;AACd,IAAI,IAAI,WAAW,CAAC,CAAC,CAAC,EAAE;AACxB,MAAM,MAAM,CAAC,CAAC;AACd,KAAK,MAAM,IAAI,CAAC,YAAY,KAAK,EAAE;AACnC,MAAM,MAAM,KAAK,CAAC,GAAG,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC;AAClC,KAAK,MAAM;AACX,MAAM,MAAM,KAAK,CAAC,GAAG,EAAE,2BAA2B,CAAC,CAAC;AACpD,KAAK;AACL,GAAG;AACH;;;;"}