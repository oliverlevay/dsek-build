{"version":3,"file":"reservations-BalPKyhj.js","sources":["../../../.svelte-kit/adapter-node/chunks/reservations.js"],"sourcesContent":["import { a as authorizedPrismaClient } from \"./authorizedPrisma.js\";\nimport { e as ensurePaymentIntentState, r as removePaymentIntent } from \"./stripeWebhooks.js\";\nimport { s as sendNotification } from \"./index3.js\";\nimport { N as NotificationType } from \"./types3.js\";\nimport { hg as tickets_errors_ticketNotFound } from \"./messages.js\";\nimport { T as TIME_TO_BUY, G as GRACE_PERIOD_WINDOW } from \"./types4.js\";\nconst ensureState = async (prisma, now, shoppableId) => {\n  const { modifiedTickets, queuedNotifications } = await removeExpiredConsumables(prisma, now);\n  const queuedNotifications2 = await performLotteryIfNecessary(\n    prisma,\n    now,\n    shoppableId\n  );\n  return {\n    modifiedTickets,\n    queuedNotifications: queuedNotifications.concat(queuedNotifications2)\n  };\n};\nconst removeExpiredConsumables = async (prisma, now) => {\n  const expiredWithIntent = await prisma.consumable.findMany({\n    where: {\n      expiresAt: {\n        not: null,\n        lte: now\n      },\n      purchasedAt: null,\n      stripeIntentId: {\n        not: null\n      }\n    }\n  });\n  if (expiredWithIntent.length > 0) {\n    const intentIds = new Set(expiredWithIntent.map((e) => e.stripeIntentId));\n    for (const intentId of intentIds) {\n      try {\n        const [, canTryAgain] = await ensurePaymentIntentState(intentId);\n        if (canTryAgain) {\n          await removePaymentIntent(intentId);\n        } else {\n        }\n      } catch {\n      }\n    }\n  }\n  const toBeRemoved = await prisma.consumable.findMany({\n    where: {\n      expiresAt: {\n        not: null,\n        lte: now\n      },\n      purchasedAt: null,\n      stripeIntentId: null\n    }\n  });\n  let queuedNotifications = [];\n  if (toBeRemoved.length > 0) {\n    queuedNotifications.push({\n      title: \"Produkt i kundvagnen har löpt ut\",\n      message: `Den reserverade tiden du hade för att skaffa produkten har löpt ut, om det finns lager kvar kan du försöka skaffa den igen här.`,\n      link: \"/shop/tickets\",\n      memberIds: toBeRemoved.map((item) => item.memberId).filter(Boolean),\n      type: NotificationType.PURCHASE_CONSUMABLE_EXPIRED\n    });\n    await prisma.consumable.deleteMany({\n      where: {\n        expiresAt: {\n          not: null,\n          lte: now\n        },\n        purchasedAt: null,\n        stripeIntentId: null\n      }\n    });\n  }\n  const { modifiedTickets, queuedNotifications: newQueuedNotifications } = await updateAllNecessaryQueues(prisma);\n  queuedNotifications = queuedNotifications.concat(newQueuedNotifications);\n  return {\n    modifiedTickets,\n    queuedNotifications\n  };\n};\nlet pruneTimeout = null;\nconst queueNextExpiredConsumablesPruning = async () => {\n  if (pruneTimeout) return;\n  const nextConsumableToExpire = await authorizedPrismaClient.consumable.findFirst({\n    where: {\n      expiresAt: {\n        not: null,\n        gt: /* @__PURE__ */ new Date()\n      }\n    },\n    orderBy: {\n      expiresAt: \"asc\"\n    }\n  });\n  if (nextConsumableToExpire == null || !nextConsumableToExpire.expiresAt)\n    return;\n  pruneTimeout = setTimeout(async () => {\n    const now = /* @__PURE__ */ new Date();\n    await withHandledNotificationQueue(\n      removeExpiredConsumables(authorizedPrismaClient, now).then(\n        (r) => r.queuedNotifications\n      )\n    );\n    if (pruneTimeout) clearTimeout(pruneTimeout);\n    await queueNextExpiredConsumablesPruning();\n  }, nextConsumableToExpire.expiresAt.valueOf() - Date.now());\n};\nconst updateAllNecessaryQueues = async (prisma) => {\n  const ticketsWithReservations = await prisma.ticket.findMany({\n    where: {\n      shoppable: {\n        reservations: {\n          some: {},\n          // 'some' ensures that there is at least one reservation\n          every: {\n            order: {\n              not: null\n              // if there is a null order, lotter should have been performed or should be performed\n            }\n          }\n        },\n        availableFrom: {\n          lte: new Date(Date.now() - GRACE_PERIOD_WINDOW)\n        }\n      }\n    },\n    include: {\n      shoppable: {\n        include: {\n          reservations: true,\n          consumables: true\n        }\n      }\n    }\n  });\n  const queuedNotifications = (await Promise.all(\n    ticketsWithReservations.map(\n      (ticket) => updateQueue(\n        prisma,\n        ticket,\n        ticket.shoppable.reservations.map((reservation) => ({\n          ...reservation,\n          shoppable: ticket.shoppable\n        })),\n        ticket.shoppable.consumables\n      )\n    )\n  )).flatMap((notifications) => notifications);\n  return {\n    modifiedTickets: ticketsWithReservations.map((t) => t.id),\n    queuedNotifications\n  };\n};\nconst updateQueue = async (prisma, ticket, reservations, consumables) => {\n  const purchasedConsumablesCount = consumables.filter(\n    (con) => con.purchasedAt != null\n  ).length;\n  if (purchasedConsumablesCount >= ticket.stock) {\n    const soldOutReservations = await prisma.consumableReservation.findMany({\n      where: {\n        shoppableId: ticket.id\n      },\n      include: {\n        shoppable: true\n      }\n    });\n    await prisma.consumableReservation.deleteMany({\n      where: {\n        shoppableId: ticket.id\n      }\n    });\n    return [\n      {\n        title: \"😢 Slutsålt:(\",\n        message: `${soldOutReservations[0]?.shoppable?.title ?? \"Biljett\"} har blivit slutsåld`,\n        memberIds: soldOutReservations.map((res) => res.memberId).filter(Boolean),\n        type: NotificationType.PURCHASE_SOLD_OUT,\n        link: \"/shop/cart\"\n      }\n    ];\n  } else {\n    return (await updateQueueGivenStock(\n      prisma,\n      ticket.id,\n      reservations,\n      consumables.length,\n      ticket.stock\n    )).queuedNotifications;\n  }\n};\nconst updateQueueGivenStock = async (prisma, shoppableId, reservations, inCartOrPurchased, stock) => {\n  if (reservations.length === 0) {\n    return {\n      moved: 0,\n      spaceLeft: stock - inCartOrPurchased,\n      queuedNotifications: []\n    };\n  }\n  if (inCartOrPurchased >= stock) {\n    return { moved: 0, spaceLeft: 0, queuedNotifications: [] };\n  }\n  const toMove = Math.min(stock - inCartOrPurchased, reservations.length);\n  const queuedNotifications = await moveReservationsToCart(\n    prisma,\n    shoppableId,\n    reservations.slice(0, toMove)\n  );\n  return {\n    moved: toMove,\n    spaceLeft: stock - inCartOrPurchased - toMove,\n    queuedNotifications\n  };\n};\nconst moveQueueForwardOneStep = async (prisma, shoppableId, fromOrder) => {\n  return await prisma.consumableReservation.updateMany({\n    where: {\n      shoppableId,\n      order: {\n        not: null,\n        gt: fromOrder\n      }\n    },\n    data: {\n      order: {\n        decrement: 1\n      }\n    }\n  });\n};\nconst moveQueueToCart = async (prisma, shoppableId, amountToMove, updateOrder) => {\n  const reservationsToMove = await prisma.consumableReservation.findMany({\n    where: {\n      shoppableId,\n      order: {\n        not: null\n      }\n    },\n    orderBy: {\n      order: \"asc\"\n    },\n    take: amountToMove,\n    include: {\n      shoppable: true\n    }\n  });\n  return await moveReservationsToCart(\n    prisma,\n    shoppableId,\n    reservationsToMove,\n    updateOrder\n  );\n};\nconst moveReservationsToCart = async (prisma, shoppableId, reservationsToMove, updateOrder = true, shouldQueueNotifications = true) => {\n  if (reservationsToMove.length === 0) return [];\n  await prisma.consumable.createMany({\n    data: reservationsToMove.map((r) => ({\n      shoppableId,\n      memberId: r.memberId,\n      externalCustomerCode: r.externalCustomerCode,\n      externalCustomerEmail: r.externalCustomerEmail,\n      expiresAt: new Date(Date.now() + TIME_TO_BUY)\n    }))\n  });\n  await prisma.consumableReservation.deleteMany({\n    where: {\n      shoppableId,\n      id: {\n        in: reservationsToMove.map((r) => r.id)\n      }\n    }\n  });\n  if (updateOrder)\n    await prisma.consumableReservation.updateMany({\n      where: {\n        shoppableId\n      },\n      data: {\n        order: {\n          decrement: reservationsToMove.length\n        }\n      }\n    });\n  if (shouldQueueNotifications) {\n    return [\n      {\n        title: \"🎉 Din tur!\",\n        message: `Det är nu din tur att få ${(reservationsToMove[0]?.shoppable.price ?? 1) > 0 ? \"köpa\" : \"skaffa\"} ${reservationsToMove[0]?.shoppable?.title ?? \"det du köade till\"}`,\n        memberIds: reservationsToMove.map((res) => res.memberId).filter(Boolean),\n        type: NotificationType.PURCHASE_TIME_TO_BUY,\n        link: \"/shop/cart\"\n      }\n    ];\n  }\n  return [];\n};\nconst performLotteryIfNecessary = async (prisma, now, shoppableId) => {\n  const ticketAfterGracePeriodWithReservations = await prisma.ticket.findUnique(\n    {\n      where: {\n        id: shoppableId,\n        shoppable: {\n          reservations: {\n            some: {\n              order: null\n            }\n          },\n          availableFrom: {\n            lte: new Date(now.valueOf() - GRACE_PERIOD_WINDOW)\n          }\n        }\n      }\n    }\n  );\n  if (ticketAfterGracePeriodWithReservations !== null) {\n    return await performReservationLottery(prisma, shoppableId);\n  }\n  return [];\n};\nconst performReservationLottery = async (prisma, shoppableId) => {\n  const reservations = await prisma.consumableReservation.findMany({\n    where: {\n      shoppableId,\n      order: null\n    },\n    include: {\n      shoppable: true\n    }\n  });\n  if (reservations.length === 0) return [];\n  const ticket = await prisma.ticket.findUnique({\n    where: {\n      id: shoppableId\n    }\n  });\n  if (ticket == null) {\n    throw new Error(tickets_errors_ticketNotFound());\n  }\n  const stock = ticket?.stock ?? 0;\n  if (reservations.length <= stock) {\n    await moveReservationsToCart(prisma, shoppableId, reservations, false);\n    return [\n      {\n        title: \"🎉 Du vann lotteriet!\",\n        message: `Det är dags att ${(reservations[0]?.shoppable.price ?? 1) > 0 ? \"köpa\" : \"skaffa\"} ${reservations[0]?.shoppable?.title ?? \"det du reserverade\"}`,\n        memberIds: reservations.map((res) => res.memberId).filter(Boolean),\n        type: NotificationType.PURCHASE_TIME_TO_BUY,\n        link: \"/shop/cart\"\n      }\n    ];\n  }\n  const shuffledReservations = shuffle(reservations);\n  const winners = shuffledReservations.slice(0, stock);\n  const losers = shuffledReservations.slice(stock);\n  await moveReservationsToCart(prisma, shoppableId, winners, false, false);\n  await Promise.all(\n    losers.map(\n      (r, i) => prisma.consumableReservation.update({\n        where: {\n          id: r.id\n        },\n        data: {\n          order: i\n        }\n      })\n    )\n  );\n  const queuedNotifications = [\n    {\n      title: \"🎉🍀 Du vann lotteriet!\",\n      message: `Det är dags att ${(reservations[0]?.shoppable.price ?? 1) > 0 ? \"köpa\" : \"skaffa\"} ${reservations[0]?.shoppable?.title ?? \"det du reserverade\"}`,\n      memberIds: winners.map((res) => res.memberId).filter(Boolean),\n      type: NotificationType.PURCHASE_TIME_TO_BUY,\n      link: \"/shop/cart\"\n    },\n    {\n      title: \"😕 Du hamnade tyvärr i kö\",\n      message: `Många reserverade samma sak som du och du hamnade i kö för ${reservations[0]?.shoppable?.title ?? \"det du reserverade\"}. Du kan se din köplats här.`,\n      memberIds: losers.map((res) => res.memberId).filter(Boolean),\n      type: NotificationType.PURCHASE_IN_QUEUE,\n      link: \"/shop/cart\"\n    }\n  ];\n  return queuedNotifications;\n};\nconst shuffle = (array) => {\n  const copy = [...array];\n  let currentIndex = copy.length;\n  while (currentIndex != 0) {\n    const randomIndex = Math.floor(Math.random() * currentIndex);\n    --currentIndex;\n    [copy[currentIndex], copy[randomIndex]] = [\n      copy[randomIndex],\n      copy[currentIndex]\n    ];\n  }\n  return copy;\n};\nconst withHandledNotificationQueue = async (queuedNotificationPromise) => {\n  const queuedNotifications = await queuedNotificationPromise;\n  sendQueuedNotifications(queuedNotifications);\n};\nconst sendQueuedNotifications = async (queuedNotifications) => {\n  if (queuedNotifications.length == 0) return;\n  const results = await Promise.allSettled(\n    queuedNotifications.map(sendNotification)\n  );\n  if (results.some((result) => result.status === \"rejected\")) {\n    console.error(\n      `${results.filter((results2) => results2.status === \"rejected\")} out of ${results.length} notification send-outs failed`\n    );\n    throw new Error(`An error was thrown when trying to send notifications.`);\n  }\n};\nexport {\n  moveQueueForwardOneStep as a,\n  ensureState as e,\n  moveQueueToCart as m,\n  performLotteryIfNecessary as p,\n  queueNextExpiredConsumablesPruning as q,\n  removeExpiredConsumables as r,\n  sendQueuedNotifications as s,\n  withHandledNotificationQueue as w\n};\n"],"names":[],"mappings":"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"}