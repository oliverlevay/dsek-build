{"version":3,"file":"loadTicketData-BaPG4Us_.js","sources":["../../../.svelte-kit/adapter-node/chunks/loadTicketData.js"],"sourcesContent":["import { p as phadderMandateFilter } from \"./types.js\";\nimport { a as apiNames } from \"./apiNames.js\";\nimport { a as authorize } from \"./authorization.js\";\nimport { e as error } from \"./index.js\";\nconst loadTicketData = async (prisma, user, ticketId) => {\n  const ticket = await prisma.ticket.findUnique({\n    where: {\n      id: ticketId\n    },\n    include: {\n      shoppable: {\n        include: {\n          questions: true,\n          // including questions where removedAt is not null, because we want to show them as well\n          consumables: {\n            include: {\n              member: true,\n              questionResponses: true\n            }\n          },\n          reservations: {\n            include: {\n              member: true\n            }\n          }\n        }\n      },\n      event: true\n    }\n  });\n  if (!ticket) throw error(404, \"Ticket not found\");\n  if (ticket.shoppable.authorId !== user.memberId) {\n    authorize(apiNames.WEBSHOP.MANAGE, user);\n  }\n  const ticketYear = ticket.event.startDatetime.getFullYear();\n  const memberWithPhadderGroups = await prisma.member.findMany({\n    where: {\n      id: {\n        in: ticket.shoppable.consumables.map((c) => c.member?.id).filter(Boolean)\n      }\n    },\n    include: {\n      nollaIn: true,\n      mandates: {\n        where: {\n          ...phadderMandateFilter(ticketYear),\n          NOT: {\n            phadderIn: null\n          }\n        },\n        include: {\n          phadderIn: true\n        }\n      }\n    }\n  });\n  const consumables = ticket.shoppable.consumables.map((c) => {\n    const member = memberWithPhadderGroups.find((m) => m.id === c.member?.id);\n    const phadderIn = member?.mandates[0]?.phadderIn ?? null;\n    const nollaIn = member?.nollaIn?.year === ticketYear ? member.nollaIn : null;\n    return {\n      ...c,\n      member: c.member ? {\n        ...c.member,\n        phadderGroup: phadderIn ?? nollaIn\n      } : c.member\n    };\n  });\n  return {\n    consumables,\n    ticket\n  };\n};\nexport {\n  loadTicketData as l\n};\n"],"names":[],"mappings":"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"}