{"version":3,"file":"committee.server-BhbLpZqL.js","sources":["../../../.svelte-kit/adapter-node/chunks/types6.js","../../../.svelte-kit/adapter-node/chunks/committee.server.js"],"sourcesContent":["import \"./index.js\";\nimport \"devalue\";\nimport \"just-clone\";\nimport \"ts-deepmerge\";\nimport \"./formData.js\";\nimport { z } from \"zod\";\nconst updateSchema = z.object({\n  name: z.string().optional(),\n  description: z.string().nullable(),\n  darkImageUrl: z.string().nullable(),\n  lightImageUrl: z.string().nullable(),\n  monoImageUrl: z.string().nullable(),\n  symbolUrl: z.string().nullable(),\n  markdown: z.string().optional(),\n  markdownEn: z.string().optional().nullable(),\n  markdownSlug: z.string().optional()\n});\nexport {\n  updateSchema as u\n};\n","import { a as compareCommitteePositions } from \"./sort.js\";\nimport { cV as committees_errors_invalidYear, cW as committees_errors_committeeNotFound, cX as committees_errors_fetchUniqueMembers, cY as committees_errors_fetchNumberOfMandates, cZ as committees_errors_fetchMarkdown, c_ as committees_committeeUpdated } from \"./messages.js\";\nimport { e as error, f as fail } from \"./index.js\";\nimport \"just-clone\";\nimport \"ts-deepmerge\";\nimport \"memoize-weak\";\nimport { z as zod } from \"./zod.js\";\nimport \"devalue\";\nimport { s as superValidate, w as withFiles, m as message } from \"./superValidate.js\";\nimport { u as updateSchema } from \"./types6.js\";\nimport { u as updateMarkdown } from \"./mutations.server.js\";\nconst getYear = (url) => {\n  const yearQuery = url.searchParams.get(\"year\");\n  const parsedYear = parseInt(yearQuery ?? \"\");\n  const year = isNaN(parsedYear) ? (/* @__PURE__ */ new Date()).getFullYear() : parsedYear;\n  return year;\n};\nconst committeeLoad = async (prisma, shortName, url) => {\n  const year = getYear(url);\n  const firstDayOfYear = /* @__PURE__ */ new Date(`${year}-01-01`);\n  const lastDayOfYear = /* @__PURE__ */ new Date(`${year}-12-31`);\n  if (firstDayOfYear.toString() === \"Invalid Date\" || lastDayOfYear.toString() === \"Invalid Date\" || firstDayOfYear.getFullYear() !== year || lastDayOfYear.getFullYear() !== year) {\n    error(400, committees_errors_invalidYear());\n  }\n  const committee = await prisma.committee.findUnique({\n    where: {\n      shortName\n    },\n    include: {\n      positions: {\n        include: {\n          mandates: {\n            where: {\n              startDate: {\n                lte: lastDayOfYear\n              },\n              endDate: {\n                gte: firstDayOfYear\n              }\n            },\n            include: {\n              member: true\n            },\n            orderBy: [\n              {\n                startDate: \"desc\"\n              },\n              {\n                member: {\n                  firstName: \"asc\"\n                }\n              },\n              {\n                member: {\n                  lastName: \"asc\"\n                }\n              }\n            ]\n          },\n          emailAliases: {\n            select: {\n              email: true\n            }\n          }\n        }\n      }\n    }\n  });\n  if (!committee) {\n    throw error(404, committees_errors_committeeNotFound());\n  }\n  const [uniqueMembersInCommittee, numberOfMandates, markdown] = await Promise.allSettled([\n    prisma.member.count({\n      where: {\n        mandates: {\n          some: {\n            startDate: {\n              lte: lastDayOfYear\n            },\n            endDate: {\n              gte: firstDayOfYear\n            },\n            position: {\n              committee: {\n                shortName\n              }\n            }\n          }\n        }\n      }\n    }),\n    prisma.mandate.count({\n      where: {\n        startDate: {\n          lte: lastDayOfYear\n        },\n        endDate: {\n          gte: firstDayOfYear\n        },\n        position: {\n          committee: {\n            shortName\n          }\n        }\n      }\n    }),\n    prisma.markdown.findUnique({\n      where: {\n        name: shortName\n      }\n    }),\n    prisma.committee.findUnique({\n      where: {\n        shortName\n      }\n    })\n  ]);\n  if (uniqueMembersInCommittee.status === \"rejected\") {\n    error(500, committees_errors_fetchUniqueMembers());\n  }\n  if (numberOfMandates.status === \"rejected\") {\n    error(500, committees_errors_fetchNumberOfMandates());\n  }\n  if (markdown.status === \"rejected\") {\n    error(500, committees_errors_fetchMarkdown());\n  }\n  const form = await superValidate(\n    {\n      ...committee,\n      markdownSlug: markdown.value?.name,\n      markdown: markdown.value?.markdown,\n      markdownEn: markdown.value?.markdownEn\n    },\n    zod(updateSchema)\n  );\n  return {\n    committee,\n    positions: committee.positions.filter((pos) => pos.mandates.length > 0 || pos.active).toSorted((a, b) => compareCommitteePositions(a.id, b.id, shortName)),\n    uniqueMemberCount: uniqueMembersInCommittee.value,\n    numberOfMandates: numberOfMandates.value,\n    markdown: markdown.value,\n    form,\n    year\n  };\n};\nconst committeeActions = (shortName) => ({\n  update: async ({ params, request, locals }) => {\n    const { user, prisma } = locals;\n    const form = await superValidate(request, zod(updateSchema), {\n      allowFiles: true\n    });\n    if (!form.valid) return fail(400, withFiles({ form }));\n    const { markdown, markdownEn, markdownSlug, ...rest } = form.data;\n    await prisma.committee.update({\n      where: { shortName: shortName ?? params.shortName },\n      data: {\n        ...rest\n      }\n    });\n    if (markdownSlug && markdown) {\n      await updateMarkdown(user, prisma, {\n        name: markdownSlug,\n        markdown,\n        markdownEn: markdownEn ?? null\n      });\n    }\n    return message(form, {\n      message: committees_committeeUpdated(),\n      type: \"success\"\n    });\n  }\n});\nexport {\n  committeeActions as a,\n  committeeLoad as c,\n  getYear as g\n};\n"],"names":[],"mappings":"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"}