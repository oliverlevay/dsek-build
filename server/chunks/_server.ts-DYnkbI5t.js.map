{"version":3,"file":"_server.ts-DYnkbI5t.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/(app)/shop/tickets/_slug_/manage/download-csv/_server.ts.js"],"sourcesContent":["import dayjs from \"dayjs\";\nimport { l as loadTicketData } from \"../../../../../../../../chunks/loadTicketData.js\";\nconst GET = async ({ locals, params }) => {\n  const { user, prisma } = locals;\n  const { ticket, consumables } = await loadTicketData(\n    prisma,\n    user,\n    params.slug\n  );\n  const csv = generateCSV(ticket, consumables);\n  const res = new Response(csv, {\n    headers: {\n      \"Content-Type\": \"text/csv\",\n      \"Content-Disposition\": `attachment; filename=${ticket.shoppable.title}.csv`\n    }\n  });\n  return res;\n};\nconst generateCSV = (ticket, consumables) => {\n  let output = \"\";\n  let headers = \"Namn,Email,Matpreferens,Phaddergrupp,Betalad mängd,Köpdatum,Payment Intent id\";\n  for (const question of ticket.shoppable.questions) {\n    headers += `,${question.title.replace(\",\", \" \")}`;\n  }\n  output += headers + \"\\n\";\n  const priceFormatter = new Intl.NumberFormat(\"sv-SE\", {\n    minimumFractionDigits: 0,\n    maximumFractionDigits: 2,\n    currency: \"SEK\",\n    currencyDisplay: \"code\"\n  });\n  for (const consumable of consumables) {\n    const member = consumable.member;\n    const name = member ? `${member.firstName} ${member.lastName}`.replace(\",\", \" \") : \"Anonym användare\";\n    const email = member ? \"Finns inte\" : consumable.externalCustomerEmail?.replace(\",\", \" \") ?? \"Finns inte\";\n    const paidAmount = consumable.priceAtPurchase ? priceFormatter.format(consumable.priceAtPurchase / 100).replace(\",\", \".\") : \"Okänt\";\n    const foodPreference = member ? member?.foodPreference?.replace(\",\", \" \") ?? \"\" : \"Anonym användare\";\n    const phadderGroup = member ? member?.phadderGroup?.name.replace(\",\", \" \") ?? \"\" : \"Anonym användare\";\n    let row = `${name},${email},${foodPreference},${phadderGroup},${paidAmount},${dayjs(\n      consumable.purchasedAt\n    ).format(\"YYYY-MM-DD HH:mm:ss\")},${consumable.stripeIntentId?.replace(\",\", \" \") ?? \"N/A\"}`;\n    for (const question of ticket.shoppable.questions) {\n      const response = consumable.questionResponses.find(\n        (r) => r.questionId === question.id\n      );\n      if (!response) row += `,`;\n      else row += `,${response.answer.replace(\",\", \" \")}`;\n    }\n    output += row + \"\\n\";\n  }\n  return output;\n};\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}