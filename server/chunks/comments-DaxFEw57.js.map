{"version":3,"file":"comments-DaxFEw57.js","sources":["../../../.svelte-kit/adapter-node/chunks/commentTagging.js","../../../.svelte-kit/adapter-node/chunks/comments.js"],"sourcesContent":["const tagRegex = /\\[([^\\]]*)\\]\\(\\/members\\/([^)]+)\\)/g;\nexport {\n  tagRegex as t\n};\n","import { t as tagRegex } from \"./commentTagging.js\";\nimport { f as fail } from \"./index.js\";\nimport \"devalue\";\nimport { s as superValidate, m as message } from \"./superValidate.js\";\nimport \"just-clone\";\nimport \"ts-deepmerge\";\nimport \"memoize-weak\";\nimport { z as zod } from \"./zod.js\";\nimport { z } from \"zod\";\nimport DOMPurify from \"isomorphic-dompurify\";\nconst getAllTaggedMembers = async (prisma, comments) => {\n  return await prisma.member.findMany({\n    where: {\n      studentId: {\n        in: [\n          ...new Set(\n            comments.flatMap(\n              (comment) => [...(comment.content ?? \"\").matchAll(tagRegex)].map((match) => match[2]).filter((taggedMember) => taggedMember)\n            )\n          )\n        ]\n      }\n    }\n  });\n};\nconst commentSchema = z.object({\n  content: z.string().min(1)\n});\nconst removeCommentSchema = z.object({\n  commentId: z.string()\n});\nconst commentAction = (entityType) => async ({\n  locals,\n  request,\n  params\n}) => {\n  const { prisma, user } = locals;\n  const form = await superValidate(request, zod(commentSchema));\n  if (!form.valid) return fail(400, { form });\n  const args = {\n    where: { slug: params[\"slug\"] },\n    data: {\n      comments: {\n        create: {\n          member: {\n            connect: {\n              studentId: user?.studentId\n            }\n          },\n          content: DOMPurify.sanitize(form.data.content),\n          published: /* @__PURE__ */ new Date()\n        }\n      }\n    }\n  };\n  switch (entityType) {\n    case \"NEWS\":\n      await prisma.article.update(args);\n      break;\n    case \"EVENT\":\n      await prisma.event.update(args);\n      break;\n    default:\n      return message(\n        form,\n        {\n          message: 'Kommentar skickades inte. \"Invalid comment entity type\"',\n          type: \"error\"\n        },\n        {\n          status: 400\n        }\n      );\n  }\n  return message(form, {\n    message: \"Kommentar skickad\",\n    type: \"hidden\"\n  });\n};\nconst removeCommentAction = (entityType) => async ({\n  locals,\n  request,\n  params\n}) => {\n  const { prisma } = locals;\n  const form = await superValidate(request, zod(removeCommentSchema));\n  if (!form.valid) return fail(400, { form });\n  const args = {\n    where: { slug: params[\"slug\"] },\n    data: {\n      comments: {\n        delete: {\n          id: form.data.commentId\n        }\n      }\n    }\n  };\n  switch (entityType) {\n    case \"NEWS\":\n      await prisma.article.update(args);\n      break;\n    case \"EVENT\":\n      await prisma.event.update(args);\n      break;\n    default:\n      return message(\n        form,\n        {\n          message: 'Kommentar kunde inte tas bort. \"Invalid comment entity type\"',\n          type: \"error\"\n        },\n        {\n          status: 400\n        }\n      );\n  }\n  return message(form, {\n    message: \"Kommentar borttagen\",\n    type: \"success\"\n  });\n};\nexport {\n  commentAction as a,\n  removeCommentAction as b,\n  commentSchema as c,\n  getAllTaggedMembers as g,\n  removeCommentSchema as r\n};\n"],"names":[],"mappings":"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"}