{"version":3,"file":"settings-D4jLKhBn.js","sources":["../../../.svelte-kit/adapter-node/chunks/settings.js"],"sourcesContent":["import { g as getAllTags } from \"./tags.js\";\nimport { e as error, f as fail } from \"./index.js\";\nconst settingsLoad = async ({ locals }) => {\n  const { user, prisma } = locals;\n  if (!user.memberId)\n    throw error(401, \"Du måste logga in för att ändra inställningar\");\n  const subscriptionSettings = await prisma.subscriptionSetting.findMany({\n    where: {\n      memberId: user.memberId\n    }\n  });\n  const subscriptions = subscriptionSettings.map((sub) => sub.type);\n  const pushSubscriptions = subscriptionSettings.map((sub) => {\n    if (sub.pushNotification) return sub.type;\n  }).filter((t) => t);\n  const subscribedTags = await prisma.member.findFirst({\n    where: {\n      id: user.memberId\n    },\n    select: {\n      subscribedTags: {}\n    }\n  });\n  return {\n    tags: await getAllTags(prisma),\n    subscribedTags,\n    subscriptions,\n    pushSubscriptions\n  };\n};\nconst settingsActions = {\n  default: async ({ locals, request }) => {\n    const { user, prisma } = locals;\n    const form = await request.formData();\n    if (!user) return fail(401, { form });\n    const subscription = form.getAll(\"subscription\");\n    const push = form.getAll(\"push\");\n    const tags = form.getAll(\"tag\");\n    try {\n      await prisma.$transaction(async (tx) => {\n        await tx.subscriptionSetting.deleteMany({\n          where: {\n            memberId: user.memberId\n          }\n        });\n        const res = await tx.subscriptionSetting.createMany({\n          data: subscription.map((sub) => {\n            return {\n              memberId: user.memberId,\n              type: sub.toString(),\n              pushNotification: push.some(\n                (tag) => sub.toString() === tag.toString()\n              )\n            };\n          })\n        });\n        if (res.count !== subscription.length) {\n          throw new Error(\n            `${res.count} created but supposed to be ${subscription.length}`\n          );\n        }\n      });\n      prisma.member.update({\n        where: {\n          id: user.memberId\n        },\n        data: {\n          subscribedTags: {\n            set: tags.map((tag) => {\n              return {\n                id: tag.toString()\n              };\n            })\n          }\n        }\n      });\n    } catch (error2) {\n      console.log(error2);\n      return fail(400, { form });\n    }\n  }\n};\nexport {\n  settingsActions as a,\n  settingsLoad as s\n};\n"],"names":[],"mappings":"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"}