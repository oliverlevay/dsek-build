{"version":3,"file":"mutations-DRRZq9nc.js","sources":["../../../.svelte-kit/adapter-node/chunks/mutations.js"],"sourcesContent":["import { ShoppableType } from \"@prisma/client\";\nconst createTicket = async (prisma, authorId, data) => {\n  return await prisma.$transaction(async (tx) => {\n    const ticket = await tx.ticket.create({\n      data: {\n        shoppable: {\n          create: {\n            title: data.title,\n            titleEn: data.titleEn,\n            description: data.description,\n            descriptionEn: data.descriptionEn,\n            price: Math.round(data.price * 100),\n            availableFrom: data.availableFrom,\n            availableTo: data.availableTo,\n            type: ShoppableType.TICKET,\n            authorId,\n            accessPolicies: (data.accessPolicies?.length ?? 0) > 0 ? {\n              createMany: {\n                data: data.accessPolicies\n              }\n            } : void 0\n          }\n        },\n        event: {\n          connect: {\n            id: data.eventId\n          }\n        },\n        stock: data.stock,\n        maxAmountPerUser: data.maxAmountPerUser\n        // optional\n      }\n    });\n    for (const question of data.questions) {\n      await tx.itemQuestion.create({\n        data: {\n          shoppableId: ticket.id,\n          ...question,\n          id: void 0,\n          options: question.options === void 0 ? void 0 : {\n            createMany: {\n              data: question.options.map((o) => ({\n                ...o,\n                extraPrice: o.extraPrice ? Math.round(o.extraPrice * 100) : o.extraPrice\n              }))\n            }\n          }\n        }\n      });\n    }\n    return ticket;\n  });\n};\nconst updateTicket = async (prisma, ticketId, data) => {\n  const updatedQuestions = data.questions.filter((q) => !!q.id);\n  const newQuestions = data.questions.filter((q) => !q.id);\n  const updatedPolicies = data.accessPolicies?.filter((p) => !!p.id);\n  const newPolicies = data.accessPolicies?.filter((p) => !p.id);\n  console.log(updatedPolicies);\n  await prisma.$transaction(async (tx) => {\n    await tx.ticket.update({\n      where: {\n        id: ticketId\n      },\n      data: {\n        shoppable: {\n          update: {\n            title: data.title,\n            titleEn: data.titleEn,\n            description: data.description,\n            descriptionEn: data.descriptionEn,\n            price: Math.round(data.price * 100),\n            availableFrom: data.availableFrom,\n            availableTo: data.availableTo,\n            type: ShoppableType.TICKET,\n            accessPolicies: updatedPolicies && updatedPolicies.length > 0 ? {\n              updateMany: updatedPolicies.map((p) => ({\n                data: {\n                  ...p\n                },\n                where: {\n                  id: p.id\n                }\n              }))\n            } : {\n              deleteMany: {}\n            }\n          }\n        },\n        event: {\n          connect: {\n            id: data.eventId\n          }\n        },\n        stock: data.stock,\n        maxAmountPerUser: data.maxAmountPerUser\n        // optional\n      }\n    });\n    if (newPolicies && newPolicies.length > 0) {\n      await tx.shoppableAccessPolicy.createMany({\n        data: newPolicies.map((p) => ({\n          ...p,\n          shoppableId: ticketId\n        }))\n      });\n    }\n    await updateQuestions(tx, ticketId, updatedQuestions, newQuestions);\n  });\n};\nconst updateQuestions = async (tx, ticketId, updatedQuestions, newQuestions) => {\n  const removableQuestions = await tx.itemQuestion.findMany({\n    where: {\n      shoppableId: ticketId,\n      id: {\n        notIn: updatedQuestions.map((q) => q.id)\n      },\n      responses: {\n        none: {}\n        // ensures no responses exist.\n      }\n    },\n    select: {\n      id: true\n    }\n  });\n  await tx.itemQuestion.deleteMany({\n    where: {\n      id: {\n        in: removableQuestions.map((q) => q.id)\n      }\n    }\n  });\n  await tx.itemQuestion.updateMany({\n    where: {\n      shoppableId: ticketId,\n      id: {\n        notIn: updatedQuestions.map((q) => q.id)\n      }\n    },\n    data: {\n      removedAt: /* @__PURE__ */ new Date()\n    }\n  });\n  for (const question of updatedQuestions) {\n    await tx.itemQuestionOption.deleteMany({\n      where: {\n        questionId: question.id\n      }\n    });\n    await tx.itemQuestion.update({\n      // have to do a loop\n      where: {\n        id: question.id\n      },\n      data: {\n        ...question,\n        id: void 0,\n        options: question.options === void 0 ? void 0 : {\n          createMany: {\n            data: question.options.map((o) => ({\n              ...o,\n              extraPrice: o.extraPrice ? Math.round(o.extraPrice * 100) : o.extraPrice\n            }))\n          }\n        }\n      }\n    });\n  }\n  if (newQuestions.length > 0) {\n    for (const question of newQuestions) {\n      await tx.itemQuestion.create({\n        data: {\n          ...question,\n          id: void 0,\n          shoppableId: ticketId,\n          options: question.options === void 0 ? void 0 : {\n            createMany: {\n              data: question.options.map((o) => ({\n                ...o,\n                extraPrice: o.extraPrice ? Math.round(o.extraPrice * 100) : o.extraPrice\n              }))\n            }\n          }\n        }\n      });\n    }\n  }\n};\nexport {\n  createTicket as c,\n  updateTicket as u\n};\n"],"names":[],"mappings":"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"}