{"version":3,"file":"getTickets-C0TF3G-c.js","sources":["../../../.svelte-kit/adapter-node/chunks/getTickets.js"],"sourcesContent":["import { B as BASIC_EVENT_FILTER } from \"./events.js\";\nimport { e as error } from \"./index.js\";\nimport dayjs from \"dayjs\";\nimport { G as GRACE_PERIOD_WINDOW, d as dbIdentification } from \"./types4.js\";\nconst ticketIncludedFields = (id) => ({\n  shoppable: {\n    include: {\n      // Get the user's consumables and reservations for this ticket\n      consumables: {\n        where: {\n          ...id,\n          OR: [\n            { purchasedAt: { not: null } },\n            { expiresAt: { gt: /* @__PURE__ */ new Date() } },\n            { expiresAt: null }\n          ]\n        }\n      },\n      reservations: { where: { ...id } },\n      _count: {\n        select: {\n          // Number of bought tickets\n          consumables: {\n            where: { purchasedAt: { not: null } }\n          },\n          reservations: {\n            where: { order: { not: null } }\n          }\n        }\n      }\n    }\n  },\n  event: { include: { tags: true } }\n});\nconst formatTicket = (ticket) => {\n  const base = {\n    ...ticket.shoppable,\n    ...ticket,\n    userItemsInCart: ticket.shoppable.consumables.filter((c) => !c.purchasedAt),\n    userReservations: ticket.shoppable.reservations,\n    gracePeriodEndsAt: new Date(\n      ticket.shoppable.availableFrom.valueOf() + GRACE_PERIOD_WINDOW\n    ),\n    isInUsersCart: ticket.shoppable.consumables.filter((c) => !c.purchasedAt).length > 0 || ticket.shoppable.reservations.length > 0,\n    userAlreadyHasMax: ticket.shoppable.consumables.filter((c) => c.purchasedAt !== null).length >= ticket.maxAmountPerUser,\n    ticketsLeft: Math.min(\n      ticket.stock - ticket.shoppable._count.consumables,\n      10\n    ),\n    // don't show more resolution to the client than > 10 or the exact number left (so people can't see how many other people buy tickets)\n    hasQueue: ticket.shoppable._count.reservations > 0\n  };\n  delete base.consumables;\n  delete base.reservations;\n  delete base.shoppable;\n  delete base._count;\n  return base;\n};\nconst shoppableAccessPolicyFilter = (userRoles, studentId) => ({\n  OR: [\n    {\n      accessPolicies: { none: {} }\n      // no access policies exist\n    },\n    {\n      accessPolicies: {\n        some: studentId ? {\n          OR: [{ role: { in: userRoles } }, { studentId }]\n        } : { role: { in: userRoles } }\n      }\n    }\n  ]\n});\nconst getTicket = async (prisma, id, user) => {\n  const { memberId, externalCode } = user ?? {};\n  if (!memberId && !externalCode) throw error(401);\n  const identification = memberId ? {\n    memberId\n  } : {\n    externalCode\n  };\n  const dbId = dbIdentification(identification);\n  const ticket = await prisma.ticket.findFirst({\n    where: {\n      id,\n      shoppable: { ...shoppableAccessPolicyFilter(user.roles, user.studentId) }\n    },\n    include: ticketIncludedFields(dbId)\n  });\n  if (!ticket) {\n    return null;\n  }\n  return formatTicket(ticket);\n};\nconst getTickets = async (prisma, user, getAll = false) => {\n  const { memberId, externalCode } = user ?? {};\n  if (!memberId && !externalCode) throw error(401);\n  const identification = memberId ? {\n    memberId\n  } : {\n    externalCode\n  };\n  const dbId = dbIdentification(identification);\n  const tenDaysAgo = dayjs().subtract(10, \"days\").toDate();\n  const tickets = await prisma.ticket.findMany({\n    where: getAll ? void 0 : {\n      shoppable: {\n        AND: [\n          { OR: [{ removedAt: null }, { removedAt: { lt: /* @__PURE__ */ new Date() } }] },\n          {\n            // show items which were available in the last 10 days\n            OR: [\n              { availableTo: null },\n              { availableTo: { gt: tenDaysAgo } }\n            ]\n          }\n        ],\n        ...shoppableAccessPolicyFilter(user.roles, user.studentId)\n      }\n    },\n    include: ticketIncludedFields(dbId),\n    orderBy: {\n      shoppable: { availableFrom: getAll ? \"desc\" : \"asc\" }\n    }\n  });\n  return tickets.map(formatTicket);\n};\nconst getEventsWithTickets = async (prisma, user, filters = {}, nollningMode = false) => {\n  const { memberId, externalCode } = user ?? {};\n  if (!memberId && !externalCode) throw error(401);\n  const identification = memberId ? {\n    memberId\n  } : {\n    externalCode\n  };\n  const dbId = dbIdentification(identification);\n  const events = await prisma.event.findMany({\n    where: {\n      ...BASIC_EVENT_FILTER(nollningMode),\n      ...filters\n    },\n    orderBy: {\n      startDatetime: \"asc\"\n    },\n    include: {\n      tickets: {\n        where: {\n          shoppable: {\n            ...shoppableAccessPolicyFilter(user.roles, user.studentId)\n          }\n        },\n        include: {\n          ...ticketIncludedFields(dbId),\n          event: false\n        }\n      },\n      tags: true\n    }\n  });\n  return events.map((event) => ({\n    ...event,\n    tickets: event.tickets.map((ticket) => {\n      const { tickets: _, ...eventData } = event;\n      return formatTicket({\n        ...ticket,\n        event: eventData\n      });\n    })\n  }));\n};\nexport {\n  getTicket as a,\n  getEventsWithTickets as b,\n  getTickets as g\n};\n"],"names":[],"mappings":"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"}