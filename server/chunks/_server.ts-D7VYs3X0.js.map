{"version":3,"file":"_server.ts-D7VYs3X0.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/(app)/api/mail/alias/_server.ts.js"],"sourcesContent":["import { g as getAliasToPositions, a as getCurrentMembersForPosition, b as getEmailsForManyMembers } from \"../../../../../../chunks/utils.js\";\nimport { a as authorizedPrismaClient } from \"../../../../../../chunks/authorizedPrisma.js\";\nconst GET = async ({ setHeaders }) => {\n  const aliasToPosToUserEmails = /* @__PURE__ */ new Map();\n  const posToAlias = await getAliasToPositions(\n    authorizedPrismaClient\n  );\n  const positionIds = new Set(\n    Array.from(posToAlias.values()).flatMap(\n      (alist) => alist.map((a) => a.positionId)\n    )\n  );\n  const positionIdsToMembers = /* @__PURE__ */ new Map();\n  for (const posId of positionIds) {\n    const members = await getCurrentMembersForPosition(\n      posId,\n      authorizedPrismaClient\n    );\n    positionIdsToMembers.set(posId, new Set(members));\n  }\n  const allMembersWithPos = [];\n  for (const [, members] of positionIdsToMembers) {\n    allMembersWithPos.push(...Array.from(members));\n  }\n  const userToEmail = await getEmailsForManyMembers(\n    allMembersWithPos.map((m) => m.memberId),\n    authorizedPrismaClient\n  );\n  for (const [alias, positions] of posToAlias) {\n    const posMap = /* @__PURE__ */ new Map();\n    for (const pos of positions) {\n      const members = positionIdsToMembers.get(pos.positionId) ?? /* @__PURE__ */ new Set();\n      const emails = Array.from(members).reduce((acc, cur) => {\n        if (cur.studentId === null) {\n          return acc;\n        }\n        const email = userToEmail.get(cur.studentId);\n        if (email !== void 0) {\n          acc.push(email);\n        }\n        return acc;\n      }, []);\n      posMap.set(pos.positionId, emails);\n    }\n    aliasToPosToUserEmails.set(alias, posMap);\n  }\n  const specialReceivers = (await authorizedPrismaClient.specialReceiver.findMany({\n    orderBy: {\n      email: \"asc\"\n    }\n  })).reduce((acc, cur) => {\n    if (acc.has(cur.email)) {\n      acc.get(cur.email)?.add(cur.targetEmail);\n    } else {\n      acc.set(cur.email, /* @__PURE__ */ new Set([cur.targetEmail]));\n    }\n    return acc;\n  }, /* @__PURE__ */ new Map());\n  let text = \"\";\n  for (const [alias, positions] of aliasToPosToUserEmails) {\n    text += `${alias.trim()} `;\n    let shouldTrim = false;\n    for (const [, userEmailsForPosition] of positions) {\n      if (specialReceivers.has(alias)) {\n        for (const target of specialReceivers.get(alias) ?? []) {\n          text += `${target.trim()}, `;\n          shouldTrim = true;\n        }\n        specialReceivers.delete(alias);\n      }\n      for (const userEmail of userEmailsForPosition) {\n        text += `${userEmail.trim()}, `;\n        shouldTrim = true;\n      }\n    }\n    if (shouldTrim) text = text.slice(0, -2);\n    text += \"\\n\";\n  }\n  for (const [email, targets] of specialReceivers) {\n    text += `${email.trim()} `;\n    for (const target of targets) {\n      text += `${target.trim()}, `;\n    }\n    if (targets.size > 0) text = text.slice(0, -2);\n    text += \"\\n\";\n  }\n  setHeaders({\n    \"Content-Type\": \"text/plain; charset=utf-8\"\n  });\n  return new Response(text);\n};\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}