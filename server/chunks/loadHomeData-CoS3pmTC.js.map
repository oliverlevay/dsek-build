{"version":3,"file":"loadHomeData-CoS3pmTC.js","sources":["../../../.svelte-kit/adapter-node/chunks/loadHomeData.js"],"sourcesContent":["import { d as PUBLIC_BUCKETS_DOCUMENTS } from \"./public.js\";\nimport { B as BASIC_EVENT_FILTER } from \"./events.js\";\nimport { f as fileHandler } from \"./fileHandler.js\";\nimport { B as BASIC_ARTICLE_FILTER } from \"./articles.js\";\nimport { e as error } from \"./index.js\";\nconst loadHomeData = async ({\n  locals,\n  fetch\n}) => {\n  const { prisma, user } = locals;\n  const now = /* @__PURE__ */ new Date();\n  const year = now.getFullYear();\n  const files = await fileHandler.getInBucket(\n    user,\n    PUBLIC_BUCKETS_DOCUMENTS,\n    \"public/\" + year + \"/\",\n    true\n  );\n  const boardMeetingFileNameRegex = /^S\\d+$/;\n  const boardMeetings = Array.from(\n    new Set(\n      files.map((obj) => obj.id.split(\"/\")[2]).filter((str) => boardMeetingFileNameRegex.test(str)).map((str) => parseInt(str.substring(1))).sort((a, b) => a - b)\n    )\n  );\n  const nextBoardMeeting = boardMeetings.pop();\n  const lastBoardMeeting = boardMeetings.pop();\n  function filterFilesByBoardMeeting(boardMeeting) {\n    return boardMeeting === void 0 ? [] : files.filter((obj) => obj.id.split(\"/\")[2] === \"S\" + boardMeeting);\n  }\n  const nextBoardMeetingFiles = filterFilesByBoardMeeting(nextBoardMeeting);\n  const lastBoardMeetingFiles = filterFilesByBoardMeeting(lastBoardMeeting);\n  const newsPromise = prisma.article.findMany({\n    where: {\n      ...BASIC_ARTICLE_FILTER()\n    },\n    orderBy: {\n      createdAt: \"desc\"\n    },\n    take: 3\n  });\n  const eventsPromise = prisma.event.findMany({\n    where: {\n      ...BASIC_EVENT_FILTER(),\n      startDatetime: {\n        gt: now\n      }\n    },\n    orderBy: {\n      startDatetime: \"asc\"\n    },\n    take: 3\n  });\n  const upcomingMeetingPromise = prisma.meeting.findFirst({\n    where: {\n      date: {\n        gt: now\n      }\n    },\n    orderBy: {\n      date: \"asc\"\n    }\n  });\n  const previousMeetingPromise = prisma.meeting.findFirst({\n    where: {\n      date: {\n        lt: now\n      }\n    },\n    orderBy: {\n      date: \"desc\"\n    }\n  });\n  const cafeOpenPromise = prisma.markdown.findFirst({\n    where: {\n      name: `cafe:open:${now.getDay() - 1}`\n      // we assign monday to 0, not sunday\n    }\n  });\n  const commitPromise = fetch(\"/api/home\").then(\n    (res) => res.json()\n  );\n  const hasActiveMandatePromise = prisma.mandate.findFirst({\n    where: {\n      startDate: { lte: now },\n      endDate: { gte: now },\n      memberId: locals.user?.memberId\n    },\n    select: {\n      id: true\n    }\n  }).then((res) => res !== null);\n  const [\n    news,\n    events,\n    upcomingMeeting,\n    previousMeeting,\n    cafeOpen,\n    commitData,\n    hasActiveMandate\n  ] = await Promise.allSettled([\n    newsPromise,\n    eventsPromise,\n    upcomingMeetingPromise,\n    previousMeetingPromise,\n    cafeOpenPromise,\n    commitPromise,\n    hasActiveMandatePromise\n  ]);\n  if (news.status === \"rejected\") {\n    throw error(500, \"Failed to fetch news\");\n  }\n  if (events.status === \"rejected\") {\n    throw error(500, \"Failed to fetch events\");\n  }\n  if (upcomingMeeting.status === \"rejected\") {\n    throw error(500, \"Failed to fetch upcoming meeting\");\n  }\n  if (previousMeeting.status === \"rejected\") {\n    throw error(500, \"Failed to fetch previous meeting\");\n  }\n  if (cafeOpen.status === \"rejected\") {\n    throw error(500, \"Failed to fetch cafe open\");\n  }\n  if (commitData.status === \"rejected\") {\n    throw error(500, \"Failed to fetch commit data\");\n  }\n  if (hasActiveMandate.status === \"rejected\") {\n    throw error(500, \"Failed to fetch mandate data\");\n  }\n  return {\n    files: { next: nextBoardMeetingFiles, last: lastBoardMeetingFiles },\n    news: news.value,\n    events: events.value,\n    meetings: {\n      upcoming: upcomingMeeting.value,\n      previous: previousMeeting.value\n    },\n    cafeOpen: cafeOpen.value,\n    commitCount: commitData.value.commitCount,\n    latestCommit: commitData.value.latestCommit,\n    hasActiveMandate: hasActiveMandate.value\n  };\n};\nexport {\n  loadHomeData as l\n};\n"],"names":[],"mappings":"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"}